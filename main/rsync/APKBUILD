# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=rsync
pkgver=3.1.2
pkgrel=3
pkgdesc="A file transfer program to keep remote files in sync"
url="http://samba.anu.edu.au/rsync/"
arch="all"
license="GPL3"
depends=
makedepends="perl acl-dev popt-dev"
subpackages="$pkgname-doc"
source="http://$pkgname.samba.org/ftp/$pkgname/$pkgname-$pkgver.tar.gz
	rsyncd.initd
	rsyncd.confd
	rsyncd.conf
	rsyncd.logrotate

	CVE-2017-16548.patch
	CVE-2017-17433.patch
	CVE-2017-17434-1.patch
	CVE-2017-17434-2.patch
	"

_builddir="$srcdir/$pkgname-$pkgver"
prepare() {
	cd "$_builddir"
	./prepare-source || return 1
	update_config_sub || return 1
}

# secfixes:
#   3.1.2-r3:
#     - CVE-2017-16548
#     - CVE-2017-17433
#     - CVE-2017-17434-1
#     - CVE-2017-17434-2

build() {
	cd "$_builddir"
	# Force IPv6 enabled, upstream bug https://bugzilla.samba.org/show_bug.cgi?id=10715
	CFLAGS="$CFLAGS -DINET6" \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		|| return 1
	make || return 1
}

package() {
	cd "$srcdir/$pkgname-$pkgver"
	make DESTDIR="$pkgdir" install || return 1
	install -D -m 755 ../rsyncd.initd ${pkgdir}/etc/init.d/rsyncd
	install -D -m 644 ../rsyncd.conf ${pkgdir}/etc/rsyncd.conf 
	install -D -m 644 ../rsyncd.confd ${pkgdir}/etc/conf.d/rsyncd
	install -D -m 644 ../rsyncd.logrotate ${pkgdir}/etc/logrotate.d/rsyncd
}

md5sums="0f758d7e000c0f7f7d3792610fad70cb  rsync-3.1.2.tar.gz
cd237feca33f6a120fee76499652a460  rsyncd.initd
e5e62e8cef29e09c22e8ba8152ec1751  rsyncd.confd
a99211a14af1766ba849035241cd5bb2  rsyncd.conf
169cafc6907a4c3787bb0462e9d6a5c2  rsyncd.logrotate
6be77245994b5711e445cd798538d2dd  CVE-2017-16548.patch
c4ceda2f5a721c3cd9f5bf257ad0f940  CVE-2017-17433.patch
7e10c6e4bde7e003a9478c0d0f7c9f64  CVE-2017-17434-1.patch
c0ac930bb57cdf481f7f8e22793d0d96  CVE-2017-17434-2.patch"
sha256sums="ecfa62a7fa3c4c18b9eccd8c16eaddee4bd308a76ea50b5c02a5840f09c0a1c2  rsync-3.1.2.tar.gz
c70ba2400123b75c869e6e3eb25108ba21d748cc3008889112cec627515fa1de  rsyncd.initd
de758791b16b89a648c01867af7f51bc9bd44e40cbe868e439b753ff5d9572e5  rsyncd.confd
2c00ca760c26bd7d6e1d8306d48eb9b27d876516c354f6d37c458871d5ac012f  rsyncd.conf
eb54100686a253d4d14c9c67fcc20f92d88c0616692bffea899c6a8f8f980c7c  rsyncd.logrotate
c3c903a09b6a0d38c6aff326c32f8031375f9f0014d701b84a66d2f3bca0d1e3  CVE-2017-16548.patch
5166ef417fdcdd2a86da009fd36cfb9f3029b7bbcb455ec89c8993c166232314  CVE-2017-17433.patch
933c2007610b621dd5325e5127e222c00c14bc7ca917a214ea58100e170af671  CVE-2017-17434-1.patch
62df413a8382d588adec050bab4daee3ce0e1c9b36728341a759b4e71dfa352e  CVE-2017-17434-2.patch"
sha512sums="4c55fd69f436ead0cb5a0b7c6fdfef9bb28ddb9c63534eb619e756b118d5b08cfc5e696498650932c86e865b37e06633da947e6720ca0c27ed5c034313ae208b  rsync-3.1.2.tar.gz
27f99ee64b99bb57fe3da55fc93fefc33326175fdcad01a3d93dea3aa61daaf21cd9b1063be572fa8abc5d2d444f2e64f0f6f64241176ae53bf61f9e4cb0dca9  rsyncd.initd
8ea9a2f1fea508fa132313fa16513eac84a9ed3ce75741c42769b56bbcd3f1bd2eb8bfdfe40a6c7f619e4281e8fc8d95d1bd84096d0b64aaacf606cd614ae5b3  rsyncd.confd
5bcd339bac70d7c2efc2a028852efb9a4a78d8b7b114979763d29d0b378afceb753954c31cca5dfb05dadd88479e5c875626e297ba31a57ee3da5ecad29dbd6d  rsyncd.conf
b8d6c0bb467a5c963317dc55478d2c10874564cd264d943d4a42037e2fce134fe001fabc92af5c6b5775e84dc310b1c8da147afaa61c99e5663c36580d8651a5  rsyncd.logrotate
a2f571bfdb5e37021ff8fee8bc80d624ccd83020e3fd5cf4119d477bb0fcdc57dab7d0f433a95136a1e259ba136e05f28d1a052ae2237805ddc611329ecb5679  CVE-2017-16548.patch
3cfc9ea4abdf288e2f524570f9f115a34f089a44eec5a73a3d5da34d64a8843d729c5cbcaecfcadb5f309ee98c11583a7d607d3eb55011cf77f9df49886f6eff  CVE-2017-17433.patch
f678175eb524505823e8ae7760c2a8e5189d2e09c03244ca88e6e2294707a76d430f52096fb1e498a13ddb8943a80ed588df66d682233c0e5243b52f57a1b5f5  CVE-2017-17434-1.patch
065f79b8b9c0ae827b0ba9abddc37af75f7e8759b4f51551182e21e07ea030e6704233540515e0745b54117899b8fc259f40b30b04a558b54306aa2e2a37e36a  CVE-2017-17434-2.patch"
