# Contributor: Leonardo Arena <rnalrd@alpinelinux.org>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
_php=php5
pkgname=roundcubemail
pkgver=1.2.7
pkgrel=0
pkgdesc="A PHP web-based mail client"
url="http://www.roundcube.net"
arch="noarch"
license="GPL3+"
install="$pkgname.post-upgrade"
depends="${_php} ${_php}-imap ${_php}-xml ${_php}-json ${_php}-dom
	${_php}-exif ${_php}-pear-net_idna2 ${_php}-pear-mail_mime
	${_php}-pear-net_smtp ${_php}-pear-auth_sasl ${_php}-openssl"
makedepends=""
subpackages="$pkgname-installer $pkgname-doc"
source="https://github.com/roundcube/$pkgname/releases/download/$pkgver/${pkgname}-$pkgver.tar.gz
	fix-dirs.patch"

_src="$srcdir"/roundcubemail-$pkgver

# secfixes:
#   1.2.7-r0:
#     - CVE-2017-16651
#   1.2.5-r0:
#     - CVE-2017-8114

prepare() {
	cd "$_src"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done

	# fix permissions
	find . -type f -print | xargs chmod a-x
	# remove .htaccess
	find . -name \.htaccess -print | xargs rm -f

	# fixup paths to use the right paths
	sed -i -e 's|temp/|/tmp/|' \
		-e 's|config/|/etc/roundcube/|' \
		-e 's|logs/|/var/log/roundcube/|' \
		config/defaults.inc.php || return 1

	# cleanup 
	sed -i 's/\r//' SQL/mssql.initial.sql
	rm -rf logs temp
}

build() {
	return 0
}

package() {
	_instdir="$pkgdir"/usr/share/webapps/roundcube
	mkdir -p "${_instdir}"
	cd "${_instdir}"
	cp -rp "$srcdir"/roundcubemail-$pkgver/* .
	# install config in /etc/roundcube so config files are not overwritten
	# on upgrades
	mkdir -p "$pkgdir"/etc/
	mv config "$pkgdir"/etc/roundcube

	install -d "$pkgdir"/var/log/roundcube
	mkdir -p "$pkgdir"/usr/share/doc/roundcube
	mkdir -p "$pkgdir"/usr/share/licenses/roundcube
	for file in CHANGELOG INSTALL README.md UPGRADING
	do
		mv "$pkgdir"/usr/share/webapps/roundcube/$file \
		  "$pkgdir"/usr/share/doc/roundcube || return 1
	done
	mv "$pkgdir"/usr/share/webapps/roundcube/LICENSE \
	  "$pkgdir"/usr/share/licenses/roundcube || return 1
}

installer() {
	pkgdesc="Roundcubemail installer script"
	mkdir -p "$subpkgdir"/usr/share/webapps/roundcube
	mv "$pkgdir"/usr/share/webapps/roundcube/installer \
		"$subpkgdir"/usr/share/webapps/roundcube
}

md5sums="aac27a55f1cca3d8fa45f7b34b2ecc8c  roundcubemail-1.2.7.tar.gz
0cfce0716e174c27c49e1c62aa30f67c  fix-dirs.patch"
sha256sums="01390256365587c40cf22f79051656daf3e4b0efe133cdfa64f9b48ea22d749b  roundcubemail-1.2.7.tar.gz
9185719a389b6cca64fc4aa73a5565858572651a71f66da0230ab180bf61e05a  fix-dirs.patch"
sha512sums="5ee9cd87a4ac593e2f71a6d8d0a73f5512e81da26608661f9dbb8a387269fa192d2d3a00c7bede3c4fbc981589460ea77af2b68a76a953cc08c3647fa6dd5322  roundcubemail-1.2.7.tar.gz
5c645ab7f130f8f3b17b7821e2cd0be88b6d7999da38876bde36c9b116bf7d34bcf52e2d8939d9359649e3fc5ddfb1cab7798ffb9e649be11bebd1d2c4ee006b  fix-dirs.patch"
