# Maintainer: Natanael Copa <ncopa@alpinelinux.org>

_luaversions="5.1 5.2 5.3"

pkgname=lua-filesystem
pkgver=1.7.0.2
pkgrel=0
pkgdesc="Filesystem functions for Lua"
url="http://keplerproject.github.io/luafilesystem/"
arch="all"
license="GPL"
depends=""
install=

makedepends=""
subpackages=""
for _i in $_luaversions; do
	makedepends="$makedepends lua$_i-dev"
	subpackages="$subpackages lua$_i-filesystem:split_${_i/./_}"
done
source="luafilesystem-$pkgver.tar.gz::https://github.com/keplerproject/luafilesystem/archive/v${pkgver//./_}.tar.gz"

_sdir="$srcdir"/luafilesystem-${pkgver//./_}

prepare() {
	cd "$_sdir"
	# apply patches here
	cd "$srcdir"
	for _i in $_luaversions; do
		cp -r "$_sdir" "$srcdir"/build-$_i
	done
}

build() {
	for _i in $_luaversions; do
		cd "$srcdir"/build-$_i
		make CFLAGS="$CFLAGS $( pkg-config lua$_i --cflags ) -fPIC" \
			|| return 1
	done
}

package() {
	for _i in $_luaversions; do
		cd "$srcdir"/build-$_i
		make LUA_LIBDIR="$pkgdir"/usr/lib/lua/$_i install \
			|| return 1
	done
}

_split() {
	local d= _ver=$1
	pkgdesc="Filesystem functions for Lua $_ver"
	install_if="lua$_ver $pkgname=$pkgver-r$pkgrel"
	depends=
	for d in usr/lib/lua usr/share/lua; do
		if [ -d "$pkgdir"/$d/$_ver ]; then
			mkdir -p "$subpkgdir"/$d
			mv "$pkgdir"/$d/$_ver "$subpkgdir"/$d/ || return 1
		fi
	done
}

for _i in $_luaversions; do
	eval "split_${_i/./_}() { _split $_i; }"
done

sha512sums="a1d4d077776e57cd878dbcd21656da141ea3686c587b5420a2b039aeaf086b7e7d05d531ee1cc2bbd7d06660d1315b09593e52143f6711f033ce8eecdc550511  luafilesystem-1.7.0.2.tar.gz"
