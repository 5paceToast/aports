# Contributor: <kalonji@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
#
# secfixes:
#   5.2-r2:
#     - CVE-2018-1083
#     - CVE-2018-1071
#
pkgname=zsh
pkgver=5.2
pkgrel=2
pkgdesc="A very advanced and programmable command interpreter (shell)"
url="http://www.zsh.org/"
arch="all"
license="BSD"
depends=
makedepends=ncurses-dev
install="zsh.post-install zsh.post-upgrade zsh.pre-deinstall"
source="http://www.zsh.org/pub/old/$pkgname-$pkgver.tar.xz
	zprofile
	fix-zle-segfault.patch
	CVE-2018-1071.patch
	CVE-2018-1083.patch"
subpackages="$pkgname-doc"

_builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	cd "$_builddir"
	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done
	update_config_sub || return 1
}

build() {
	cd "$_builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--bindir=/bin \
		--enable-etcdir=/etc/zsh \
		--enable-multibyte \
		--enable-function-subdirs \
		--enable-zsh-secure-free \
		--sysconfdir=/etc \
		--with-tcsetpgrp \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		|| return 1
	make || return 1
}

package() {
	cd "$_builddir"
	make DESTDIR="$pkgdir" install || return 1
	install -Dm644 "$srcdir"/zprofile "$pkgdir"/etc/zsh/zprofile
}
md5sums="afe96fde08b70e23c1cab1ca7a68fb34  zsh-5.2.tar.xz
a5e93cd6880da04a63fc4fcaaa03987f  zprofile
1413688affa980b053dd2cdc784f8626  fix-zle-segfault.patch
bd6114acb5c860221caa33474f39ca8b  CVE-2018-1071.patch
d19a32cdbbd7552df2b25c41dc1c0f4c  CVE-2018-1083.patch"
sha256sums="f17916320ffaa844bbd7ce48ceeb5945fc5f3eff64b149b4229bbfbdf3795a9d  zsh-5.2.tar.xz
e3c3625d966c8277274798f26241857df5fc520e18674deba6cc356f6b022d63  zprofile
7b8bfec6f7c0df6954eb27a000ff1d077e37a1ec9fd9f37c247a53922cf0c9be  fix-zle-segfault.patch
06ef561b4d1f174625971643ea54cbf75335fe456110f8a26b764b78b37285e9  CVE-2018-1071.patch
d53d8db4abf80e262ae48da56cd103881521e94fa25bac5573617cbbed06e76c  CVE-2018-1083.patch"
sha512sums="9938af95e09203a0a313f441e0c23279136806f6f087475ca9a66c678c57ecffc87f73ece8133a36700af8de7cb5d1bec8559eabdec2b66102062e64026c2e72  zsh-5.2.tar.xz
59182b99447872ded8adf0d890e9359ee47fce0b7acb2808f4308f945885fbf6d977a0917bbb5c0f21454caf3ba06ab092127732da4f84292d6ab0989a0110fe  zprofile
f17016b4cb95932caabdfca273696f4a444f1e45c8e7d458db54ae12542fce87bdd6fc6c4cd070948041f50760389179c69c12296665b7b9651007faafbdbee7  fix-zle-segfault.patch
9e645c31ace8e255a3859fe732572be7e4f7bde025c17f0cc4cdfedfc5ffb30b42e5051162efcb2f58bb89e92701dab0528fa3157faf2445aca3cec3d85e1da8  CVE-2018-1071.patch
4e4c3c67c4ce73607d735e99884ca2ef833f4f8859f30882b69bf6e785f99a4637c0650f6a8d474e0f3d86f7400499557a04c327990ef999c1aedca598e13848  CVE-2018-1083.patch"
