# Contributor: Leonardo Arena <rnalrd@alpinelinux.org>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
_php=php7
pkgname=roundcubemail
pkgver=1.3.6
pkgrel=1
pkgdesc="A PHP web-based mail client"
url="http://www.roundcube.net"
arch="noarch"
license="GPL3+"
install="$pkgname.post-upgrade"
depends="${_php} ${_php}-imap ${_php}-xml ${_php}-json ${_php}-dom
	${_php}-exif ${_php}-pear-net_idna2 ${_php}-pear-mail_mime
	${_php}-pear-net_smtp ${_php}-pear-auth_sasl ${_php}-openssl
	${_php}-session ${_php}-mbstring ${_php}-iconv ${_php}-intl
	"
options="!check"
subpackages="$pkgname-installer $pkgname-doc"
source="https://github.com/roundcube/$pkgname/releases/download/$pkgver/$pkgname-$pkgver-complete.tar.gz
	fix-dirs.patch"
builddir="$srcdir"/roundcubemail-$pkgver

# secfixes:
#   1.3.6-r0:
#     - CVE-2018-9846
#   1.2.7-r0:
#     - CVE-2017-16651
#   1.2.5-r0:
#     - CVE-2017-8114

prepare() {
	cd "$builddir"
	default_prepare

	# fix permissions
	find . -type f -print | xargs chmod a-x
	# remove .htaccess
	find . -name \.htaccess -print | xargs rm -f

	# fixup paths to use the right paths
	sed -i -e 's|temp/|/tmp/|' \
		-e 's|config/|/etc/roundcube/|' \
		-e 's|logs/|/var/log/roundcube/|' \
		config/defaults.inc.php || return 1

	# cleanup
	sed -i 's/\r//' SQL/mssql.initial.sql
	rm -rf logs temp
}

build() {
	return 0
}

package() {
	_instdir="$pkgdir"/usr/share/webapps/roundcube
	mkdir -p "${_instdir}"
	cd "${_instdir}"
	cp -rp "$builddir"/* .
	# install config in /etc/roundcube so config files are not overwritten
	# on upgrades
	mkdir -p "$pkgdir"/etc/
	mv config "$pkgdir"/etc/roundcube

	install -d "$pkgdir"/var/log/roundcube
	mkdir -p "$pkgdir"/usr/share/doc/roundcube
	mkdir -p "$pkgdir"/usr/share/licenses/roundcube
	for file in CHANGELOG INSTALL README.md UPGRADING
	do
		mv "$pkgdir"/usr/share/webapps/roundcube/$file \
		  "$pkgdir"/usr/share/doc/roundcube || return 1
	done
	mv "$pkgdir"/usr/share/webapps/roundcube/LICENSE \
	  "$pkgdir"/usr/share/licenses/roundcube || return 1
}

installer() {
	pkgdesc="Roundcubemail installer script"
	mkdir -p "$subpkgdir"/usr/share/webapps/roundcube
	mv "$pkgdir"/usr/share/webapps/roundcube/installer \
		"$subpkgdir"/usr/share/webapps/roundcube
}

sha512sums="fc1627d4b539742524c43b3faaa8cb5d64f934ad03f7cf8a461580a3a38dccb11140d08499b988742a0892534b1eda52f37a50f0911015983b6e27703294c70e  roundcubemail-1.3.6-complete.tar.gz
a8dc9e9493f9b24441378f6a526eb26e4dd4b0ef0cafaf25dd55c334b92df88dcb06008f46404a80eae0520ac04431c5b2237fd662c85c31fc6ee2b0d8fa9435  fix-dirs.patch"
