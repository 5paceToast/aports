# Contributor: Borys Zhukov <mp5@mp5.im>
# Maintainer: Borys Zhukov <mp5@mp5.im>
pkgname=ocaml
pkgver=4.06.1
pkgrel=0
pkgdesc="Main implementation of the Caml programming language"
url="http://ocaml.org/"
arch="all !x86 !armhf !s390x"
license="LGPL-2.1-or-later-WITH-linking-exception"
makedepends="ncurses-dev zlib-dev gdbm-dev gcc libc-dev"
depends="ncurses-dev"
options="textrels"
subpackages="$pkgname-doc"
source="http://caml.inria.fr/pub/distrib/ocaml-${pkgver%.*}/$pkgname-$pkgver.tar.gz
	fix-mcontext-fields.patch
	fix-segfault-in-ppc64le.patch
	"
builddir="$srcdir/$pkgname-$pkgver"

build() {
	cd "$builddir"

	# Strip out -fomit-frame-pointer due to -pg.
	export CFLAGS="${CFLAGS/-fomit-frame-pointer/} -fPIC"

	./configure -cc "${CC:-gcc}" \
		--bindir /usr/bin \
		--libdir /usr/lib/ocaml \
		--mandir /usr/share/man
	make -j1 world.opt
}

check() {
	cd "$builddir"

	# FIXME: there seem to be some spurious failures, ignore until fixed.
	make test || true
	make -C testsuite report || true
}

package() {
	cd "$builddir"

	make install \
		BINDIR="$pkgdir"/usr/bin \
		LIBDIR="$pkgdir"/usr/lib/ocaml \
		MANDIR="$pkgdir"/usr/share/man

	install -Dm644 LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
	install -Dm644 Changes "$pkgdir"/usr/share/doc/$pkgname/Changes

	find "$pkgdir"/usr/lib/ocaml -name \*.ml -delete
}

sha512sums="42560874ce363212fa4e862138d7260113bc8dff8b39c040332bbd9b039ba938788344ba8ce63ffc0a251bf21a6e493f3c1e505b6f51db6fec4d21578921060e  ocaml-4.06.1.tar.gz
75c67e143a4a05b334bdebbad48ded1e04d383d8ea9b747df2633a5af96b1115b502510faf57753c71bbac38fbc9d9746b167861a63b2fd295901db0d22ea317  fix-mcontext-fields.patch
b2cef41400b31c1dcfd206c1534827f7b33b0afd6234b26fb95cf15c092affa85c27a615c14ece254ec326430f31b58ca70b9cc23a84ebf8baac2624bd5b0a71  fix-segfault-in-ppc64le.patch"
