# Maintainer: TBK <alpine@jjtc.eu>
# Contributer: TBK <alpine@jjtc.eu>
pkgname=unifi
_pkgname=UniFi
pkgver=5.6.22
pkgrel=0
pkgdesc="The Ubiquiti UniFi network controller"
url="http://wiki.ubnt.com/UniFi_FAQ"
arch="noarch"
license="UniFi-EULA"
depends="openjdk8-jre-base java-snappy mongodb"
install="$pkgname.pre-install"
pkgusers="$pkgname"
pkggroups="$pkgname"
options="!check !fhs"
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.zip::https://dl.ubnt.com/$pkgname/$pkgver/$_pkgname.unix.zip
        $pkgname.initd
        $pkgname.logrotated
        "
builddir="$srcdir/$_pkgname"

prepare() {
	default_prepare
	# removing libubnt_webrtc_jni.so which disables rtc support
	# which disabled cloud features (afaik)
	rm -rf "$builddir"/lib/native
}

package() {
	cd "$builddir"
	# unifi wants everything in a base directory but we dont
	local basedir="$pkgdir/usr/lib/$pkgname"
	local datadir="$pkgdir/var/lib/$pkgname"
	local webapps="$pkgdir/usr/share/webapps"
	
	mkdir -p $basedir/bin $datadir $webapps

        install -Dm644 "$srcdir"/$pkgname.logrotated \
                "$pkgdir"/etc/logrotate.d/$pkgname
        install -Dm755 "$srcdir"/$pkgname.initd \
                "$pkgdir"/etc/init.d/$pkgname
        install -Dm644 readme.txt \
                "$pkgdir"/usr/share/doc/$pkgname/readme.txt

	cp -r webapps $webapps/$pkgname

	local dir; for dir in dl lib conf; do
		cp -r $dir "$basedir"/
	done
	
	local dir; for dir in work data; do
		install -dm 755 -o $pkgname -g $pkgname "$datadir/$dir"
	done
        
	# link things back to basedir
	ln -sf /usr/bin/mongod $basedir/bin/mongod
	ln -sf /var/log/$pkgname $basedir/logs
	ln -sf /run/$pkgname $basedir/run
	ln -sf /usr/share/webapps/$pkgname $basedir/webapps
	ln -sf /var/lib/$pkgname/data $basedir/data
	ln -sf /var/lib/$pkgname/work $basedir/work
	
	
	# overwrite with local snappy
	ln -sf /usr/share/java/snappy-java-1.1.2.6.jar \
		"$basedir"/lib/snappy-java-1.1.2.6.jar
	
	# make sure datadir is writable by our user
	chown -R $pkgname:$pkgname $datadir
}
sha512sums="5fa9f0b6904c61b13e1c2430c0244404797795c119323eec61c296e6412184a114389d3db62e4d70e274d972768e030c8436820f2c20ac23767d145e8f8fedcc  unifi-5.6.22.zip
d0f5a6fe23e4d9e24f0beb7b8c1d19be99ebc27784457a802f49c4d0f1b3182a0d22f820a289a728db93d65fcb0b46397dc7cd57f793c9b48bbc876f97250423  unifi.initd
c4293d5908b7a843044c9f9645232c7a385f92384eb52b040039ead1cbc4f8902e7276ac9650b2842d8014ce06cdd1de445a55c84d80dcf994626fbf356bdf65  unifi.logrotated"
